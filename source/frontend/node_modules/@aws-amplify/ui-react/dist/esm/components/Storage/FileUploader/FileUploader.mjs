import{__rest as e}from"tslib";import i,{useState as t,useEffect as r,useCallback as s,useMemo as o}from"react";import{Storage as l}from"@aws-amplify/storage";import{translate as m,uploadFile as a,isValidExtension as n}from"@aws-amplify/ui";import{Logger as p}from"aws-amplify";import"../../../primitives/Alert/Alert.mjs";import"../../../primitives/Autocomplete/Autocomplete.mjs";import"../../../primitives/Badge/Badge.mjs";import{Button as c}from"../../../primitives/Button/Button.mjs";import"../../../primitives/ButtonGroup/ButtonGroup.mjs";import"../../../primitives/Card/Card.mjs";import"../../../primitives/CheckboxField/CheckboxField.mjs";import"../../../primitives/Collection/Collection.mjs";import"../../../primitives/Divider/Divider.mjs";import"../../../primitives/Expander/Expander.mjs";import"../../../primitives/Expander/ExpanderItem.mjs";import"../../../primitives/FieldGroupIcon/FieldGroupIcon.mjs";import"../../../primitives/FieldGroupIcon/FieldGroupIconButton.mjs";import"../../../primitives/Flex/Flex.mjs";import"../../../primitives/Grid/Grid.mjs";import"../../../primitives/Heading/Heading.mjs";import"../../../primitives/HighlightMatch/HighlightMatch.mjs";import"../../../primitives/Icon/Icon.mjs";import"../../../primitives/Image/Image.mjs";import"../../../primitives/Link/Link.mjs";import"../../../primitives/Loader/Loader.mjs";import"../../../primitives/Menu/Menu.mjs";import"../../../primitives/Menu/MenuButton.mjs";import"../../../primitives/Menu/MenuItem.mjs";import"../../../primitives/Pagination/Pagination.mjs";import"../../../primitives/PasswordField/PasswordField.mjs";import"../../../primitives/PhoneNumberField/PhoneNumberField.mjs";import"../../../primitives/Placeholder/Placeholder.mjs";import"../../../primitives/Radio/Radio.mjs";import"../../../primitives/RadioGroupField/RadioGroupField.mjs";import"../../../primitives/Rating/Rating.mjs";import"../../../primitives/ScrollView/ScrollView.mjs";import"../../../primitives/SearchField/SearchField.mjs";import"../../../primitives/SelectField/SelectField.mjs";import"../../../primitives/SliderField/SliderField.mjs";import"../../../primitives/StepperField/StepperField.mjs";import"../../../primitives/SwitchField/SwitchField.mjs";import"../../../primitives/Table/Table.mjs";import"../../../primitives/Table/TableBody.mjs";import"../../../primitives/Table/TableCell.mjs";import"../../../primitives/Table/TableFoot.mjs";import"../../../primitives/Table/TableHead.mjs";import"../../../primitives/Table/TableRow.mjs";import"../../../primitives/Tabs/Tabs.mjs";import"../../../primitives/Text/Text.mjs";import"../../../primitives/TextAreaField/TextAreaField.mjs";import"../../../primitives/TextField/TextField.mjs";import"../../../primitives/ToggleButton/ToggleButton.mjs";import"../../../primitives/ToggleButtonGroup/ToggleButtonGroup.mjs";import"../../../primitives/View/View.mjs";import{VisuallyHidden as d}from"../../../primitives/VisuallyHidden/VisuallyHidden.mjs";import{ComponentClassNames as u}from"../../../primitives/shared/constants.mjs";import v from"./hooks/useFileUploader/useFileUploader.mjs";import{UploadPreviewer as g}from"./UploadPreviewer/index.mjs";import{UploadDropZone as j}from"./UploadDropZone/index.mjs";import{UploadTracker as f}from"./UploadTracker/index.mjs";const b=e=>"function"==typeof(null==e?void 0:e.resume),F=new p("AmplifyUI:Storage");function h(p){var{acceptedFileTypes:h,shouldAutoProceed:S=!1,isPreviewerVisible:T,maxFileCount:w,maxSize:x,hasMultipleFiles:E=!0,onError:k,onSuccess:C,showImages:O=!0,accessLevel:P,variation:y="drop",isResumable:I=!1}=p,M=e(p,["acceptedFileTypes","shouldAutoProceed","isPreviewerVisible","maxFileCount","maxSize","hasMultipleFiles","onError","onSuccess","showImages","accessLevel","variation","isResumable"]);h&&P||F.warn("FileUploader requires accessLevel and acceptedFileTypes props");const[B,R]=t(!1),[G,A]=t(!1),L=v({maxSize:x,acceptedFileTypes:h,hasMultipleFiles:E,isLoading:B,setAutoLoad:A}),{addTargetFiles:D,fileStatuses:U,inDropZone:V,setFileStatuses:H,setShowPreviewer:Z,showPreviewer:z}=L,N=e(L,["addTargetFiles","fileStatuses","inDropZone","setFileStatuses","setShowPreviewer","showPreviewer"]),q=Math.floor(U.reduce(((e,i)=>{var t;return e+(null!==(t=null==i?void 0:i.percentage)&&void 0!==t?t:0)}),0)/U.length),W=0!==U.length&&U.every((e=>100===(null==e?void 0:e.percentage))),J=U.filter((e=>100!==e.percentage)).length>w;r((()=>{100===Math.floor(q)&&R(!1)}),[q]),r((()=>{Z(T)}),[Z,T]);const K=s((e=>i=>{H((t=>{const r=Object.assign({},t[e]),s=0!==i.total?Math.floor(i.loaded/i.total*100):100,o=100!==s?"loading":"success",l=Object.assign(Object.assign({},r),{percentage:s,fileState:o});return t[e]=l,[...t]}))}),[H]),Q=s((e=>i=>{H((t=>{const r=Object.assign({},t[e]),s=Object.assign(Object.assign({},r),{fileState:"error",fileErrors:m(i.toString())});return t[e]=s,[...t]})),R(!1),"function"==typeof k&&k(i)}),[k,H]),X=s((e=>function(){const i=U[e];b(i.uploadTask)&&i.uploadTask.pause();const t=[...U];t[e]=Object.assign(Object.assign({},i),{fileState:"paused"}),H(t)}),[U,H]),Y=s((e=>function(){const i=U[e];b(i.uploadTask)&&i.uploadTask.resume();const t=[...U];t[e]=Object.assign(Object.assign({},i),{fileState:"resume"}),H(t)}),[U,H]),$=s((()=>{R(!0);const e=[];U.forEach(((i,t)=>{if("success"===(null==i?void 0:i.fileState))return;const r=a(Object.assign({file:i.file,fileName:i.name,level:P,isResumable:I,progressCallback:K(t),errorCallback:Q(t),completeCallback:C},M));b(r)&&I&&e.push(r)})),H((i=>i.map(((i,t)=>{var r,s;return Object.assign(Object.assign({},i),{uploadTask:null==e?void 0:e[t],fileState:null!==(r=i.fileState)&&void 0!==r?r:"loading",percentage:null!==(s=i.percentage)&&void 0!==s?s:0})}))))}),[Q,U,I,C,K,M,H,P]),_=s((e=>{if(!e.target.files||0===e.target.files.length)return;const{files:i}=e.target;D([...i])>0&&(Z(!0),A(!0))}),[D,Z]),ee=s((()=>{Z(!1),H([])}),[H,Z]),ie=s((e=>()=>{const{fileState:i,uploadTask:t}=U[e];"loading"===i&&b(t)&&(l.cancel(t),R(!1));const r=U.filter(((i,t)=>t!==e));H(r)}),[U,H]),te=s((e=>i=>{if(0===i.trim().length)return;const t=[...U],r=U[e],s=n(i,r.file.name);t[e]=Object.assign(Object.assign({},r),{name:i,fileState:s?null:"error",fileErrors:s?void 0:m("Extension not allowed")}),H(t)}),[U,H]),re=s(((e,i)=>{H((t=>{const r=[...t],s=r[e],o=n(s.name,s.file.name)?null:"error",l=null===i?o:i;return r[e]=Object.assign(Object.assign({},s),{fileState:l}),r}))}),[H]),se=s((e=>()=>{re(e,null)}),[re]),oe=s((e=>i=>{re(e,"editing")}),[re]);r((()=>{S&&G&&!J&&($(),A(!1))}),[S,$,G,J]);const le=i.useRef(),me=null==h?void 0:h.join(),ae=o((()=>i.createElement(i.Fragment,null,i.createElement(c,{className:u.FileUploaderDropZoneButton,isDisabled:B,onClick:()=>{le.current.click(),le.current.value=null},size:"small"},m("Browse files")),i.createElement(d,null,i.createElement("input",{type:"file",tabIndex:-1,ref:le,onChange:_,multiple:E,accept:me})))),[B,_,E,me]);return z?i.createElement(g,{dropZone:i.createElement(j,Object.assign({},N,{inDropZone:V}),ae),fileStatuses:U,isLoading:B,isSuccessful:W,hasMaxFilesError:J,maxFileCount:w,onClear:ee,onFileClick:$,aggregatePercentage:q},null==U?void 0:U.map(((e,t)=>{var r;return i.createElement(f,{errorMessage:null==e?void 0:e.fileErrors,file:e.file,fileState:null==e?void 0:e.fileState,hasImage:null===(r=e.file)||void 0===r?void 0:r.type.startsWith("image/"),showImage:O,key:t,name:e.name,onCancel:ie(t),onCancelEdit:se(t),onPause:X(t),onResume:Y(t),onSaveEdit:te(t),onStartEdit:oe(t),percentage:e.percentage,isResumable:I})}))):"button"===y?ae:i.createElement(j,Object.assign({},N,{inDropZone:V}),ae)}export{h as FileUploader};
